<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NavMark - 极速书签导航</title>
    <meta name="description" content="本地化、私密、高效的书签管理工具">
    <link rel="icon" type="image/svg+xml" href="https://www.google.com/s2/favicons?domain=google.com">
    
    <!-- 核心库 CDN (本地运行必备) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <!-- 图标库 -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        dark: '#0f172a',
                        darker: '#020617',
                        card: '#1e293b',
                        // 定义 Dim 模式的颜色 (Zinc 色系)
                        dim: {
                            bg: '#27272a',      // Zinc 800
                            card: '#3f3f46',    // Zinc 700
                            sidebar: '#18181b', // Zinc 900
                            border: '#52525b',  // Zinc 600
                            text: '#f4f4f5'     // Zinc 100
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'scale-in': 'scaleIn 0.1s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        scaleIn: { '0%': { transform: 'scale(0.95)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* 拖拽时的样式 */
        .sortable-ghost { opacity: 0.4; background: #e2e8f0; border: 2px dashed #94a3b8; }
        .dark .sortable-ghost { background: #334155; border-color: #64748b; }
        .sortable-drag { cursor: grabbing; opacity: 1; transform: scale(1.05) rotate(1deg); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); z-index: 9999; }
        
        /* 隐藏 Vue 未编译模板 */
        [v-cloak] { display: none; }
    </style>
</head>
<body class="transition-colors duration-300 min-h-screen font-sans selection:bg-blue-200 dark:selection:bg-blue-900">

<div id="app" v-cloak class="flex h-screen overflow-hidden text-gray-900 dark:text-gray-100" @click="closeAllMenus">

    <!-- 侧边栏 (设置 & 工具) -->
    <aside :class="[
        'fixed inset-y-0 left-0 z-[60] w-80 shadow-2xl transform transition-transform duration-300 ease-in-out overflow-y-auto flex flex-col border-r',
        sidebarOpen ? 'translate-x-0' : '-translate-x-full',
        theme === 'light' ? 'bg-white border-gray-200' : 
        theme === 'dim' ? 'bg-dim-sidebar border-dim-border text-dim-text' : 
        'bg-card border-gray-800'
    ]">
        
        <!-- 侧边栏顶部装饰 -->
        <div class="h-32 bg-gradient-to-br from-blue-600 to-indigo-700 relative flex items-end p-6 shrink-0">
            <button @click.stop="sidebarOpen = false" class="absolute top-4 right-4 p-2 text-white/80 hover:text-white hover:bg-white/10 rounded-full transition-colors"><i class="ph ph-x text-xl"></i></button>
            <div>
                <h2 class="text-2xl font-black text-white tracking-tight">NavMark</h2>
                <p class="text-blue-100 text-xs font-medium mt-1">你的私人书签库</p>
            </div>
        </div>

        <!-- 侧边栏内容区 -->
        <div class="py-8 pr-6 pl-12 space-y-10 flex-1">
            
            <!-- 统计信息 -->
            <div class="grid grid-cols-2 gap-4">
                <div :class="['rounded-2xl p-4 text-center border transition-colors', theme === 'light' ? 'bg-blue-50 border-blue-100' : 'bg-blue-500/10 border-blue-500/20']">
                    <div class="text-xs text-blue-500 font-bold uppercase tracking-wide mb-1">总书签</div>
                    <div :class="['text-3xl font-black', theme === 'light' ? 'text-blue-700' : 'text-blue-400']">{{ totalBookmarks }}</div>
                </div>
                <div :class="['rounded-2xl p-4 text-center border transition-colors', theme === 'light' ? 'bg-purple-50 border-purple-100' : 'bg-purple-500/10 border-purple-500/20']">
                    <div class="text-xs text-purple-500 font-bold uppercase tracking-wide mb-1">分类</div>
                    <div :class="['text-3xl font-black', theme === 'light' ? 'text-purple-700' : 'text-purple-400']">{{ categories.length }}</div>
                </div>
            </div>

            <!-- 外观 -->
            <section>
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 pl-1">外观设置</h3>
                <div :class="['flex p-1 rounded-xl', theme === 'light' ? 'bg-gray-100' : 'bg-white/10']">
                    <button @click="toggleTheme('light')" :class="['flex-1 py-2 text-xs font-bold rounded-lg flex flex-col items-center justify-center gap-1 transition-all', theme === 'light' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-300']">
                        <i class="ph ph-sun text-lg"></i> 浅色
                    </button>
                    <button @click="toggleTheme('dim')" :class="['flex-1 py-2 text-xs font-bold rounded-lg flex flex-col items-center justify-center gap-1 transition-all', theme === 'dim' ? 'bg-dim-card text-white shadow-sm' : 'text-gray-500 hover:text-gray-300']">
                        <i class="ph ph-cloud-moon text-lg"></i> 护眼
                    </button>
                    <button @click="toggleTheme('dark')" :class="['flex-1 py-2 text-xs font-bold rounded-lg flex flex-col items-center justify-center gap-1 transition-all', theme === 'dark' ? 'bg-gray-700 text-white shadow-sm' : 'text-gray-500 hover:text-gray-300']">
                        <i class="ph ph-moon text-lg"></i> 深色
                    </button>
                </div>
            </section>

            <!-- 视图控制 -->
            <section>
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 pl-1">视图控制</h3>
                <div class="space-y-3">
                    <button @click="toggleAllCategories(false)" :class="['w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-colors border border-transparent', theme === 'light' ? 'bg-gray-50 hover:bg-blue-50 text-gray-700 hover:text-blue-600' : 'bg-white/5 hover:bg-blue-500/10 text-gray-300 hover:text-blue-400 hover:border-blue-500/20']">
                        <i class="ph ph-arrows-out-line-horizontal text-lg"></i> 展开所有分类
                    </button>
                    <button @click="toggleAllCategories(true)" :class="['w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-colors border border-transparent', theme === 'light' ? 'bg-gray-50 hover:bg-blue-50 text-gray-700 hover:text-blue-600' : 'bg-white/5 hover:bg-blue-500/10 text-gray-300 hover:text-blue-400 hover:border-blue-500/20']">
                        <i class="ph ph-arrows-in-line-horizontal text-lg"></i> 折叠所有分类
                    </button>
                </div>
            </section>

            <!-- 数据管理 -->
            <section>
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4 pl-1">数据备份</h3>
                <div class="space-y-3">
                    <label :class="['w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-colors cursor-pointer group', theme === 'light' ? 'hover:bg-gray-100' : 'hover:bg-white/5']">
                        <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-500 group-hover:bg-blue-500/20 transition-colors"><i class="ph ph-upload-simple"></i></div>
                        <span>导入 Chrome 书签</span>
                        <input type="file" class="hidden" accept=".html" @change="importBookmarks">
                    </label>
                    <button @click="exportBookmarks('html')" :class="['w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-colors group', theme === 'light' ? 'hover:bg-gray-100' : 'hover:bg-white/5']">
                        <div class="w-8 h-8 rounded-lg bg-green-500/10 flex items-center justify-center text-green-500 group-hover:bg-green-500/20 transition-colors"><i class="ph ph-download-simple"></i></div>
                        <span>导出为 HTML</span>
                    </button>
                    <button @click="deduplicateBookmarks" :class="['w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-colors group', theme === 'light' ? 'hover:bg-gray-100' : 'hover:bg-white/5']">
                        <div class="w-8 h-8 rounded-lg bg-purple-500/10 flex items-center justify-center text-purple-500 group-hover:bg-purple-500/20 transition-colors"><i class="ph ph-magic-wand"></i></div>
                        <span>智能去重</span>
                    </button>
                </div>
            </section>

            <!-- 危险区域 -->
            <section>
                <h3 class="text-xs font-bold text-red-400 uppercase tracking-wider mb-4 pl-1">危险操作</h3>
                <button @click="resetData" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-bold text-red-600 bg-red-500/10 rounded-xl hover:bg-red-500/20 transition-colors border border-red-500/20">
                    <i class="ph ph-trash text-lg"></i> 恢复默认设置
                </button>
            </section>
        </div>
        
        <div class="p-6 text-center text-xs text-gray-500 border-t border-white/5 bg-black/5">
            NavMark v2.3 Ultimate
        </div>
    </aside>
    <!-- 侧边栏遮罩 -->
    <div v-if="sidebarOpen" @click="sidebarOpen = false" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 transition-opacity"></div>

    <!-- 主内容区 -->
    <main :class="[
        'flex-1 flex flex-col h-full relative overflow-hidden transition-colors duration-300',
        theme === 'light' ? 'bg-gray-50' : 
        theme === 'dim' ? 'bg-dim-bg' : 
        'bg-[#0f172a]'
    ]">
        
        <!-- 顶部导航栏 -->
        <header :class="[
            'flex-none px-6 py-4 flex items-center justify-between backdrop-blur-md border-b z-40 transition-colors',
            theme === 'light' ? 'bg-white/80 border-gray-200' : 
            theme === 'dim' ? 'bg-dim-bg/80 border-dim-border' : 
            'bg-[#0f172a]/80 border-gray-800'
        ]">
            <div class="flex items-center gap-4">
                <button @click.stop="sidebarOpen = true" class="p-2.5 text-gray-500 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-xl transition-all">
                    <i class="ph ph-list text-2xl"></i>
                </button>
                <div class="hidden sm:flex items-center gap-3">
                    <h1 class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">NavMark</h1>
                    <span class="px-2.5 py-0.5 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-xs font-bold flex items-center gap-1" title="总书签数">
                        <i class="ph ph-bookmark-simple-fill"></i> {{ totalBookmarks }}
                    </span>
                </div>
            </div>

            <!-- 搜索框 -->
            <div class="flex-1 max-w-2xl mx-4 relative group">
                <i class="ph ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-blue-500 text-lg transition-colors"></i>
                <input 
                    v-model="searchQuery"
                    type="text" 
                    placeholder="搜索书签 (搜索时无法拖拽排序)..." 
                    :class="[
                        'w-full pl-12 pr-4 py-3 border-2 border-transparent focus:border-blue-500 rounded-2xl outline-none transition-all shadow-sm hover:shadow text-base',
                        theme === 'light' ? 'bg-gray-100 focus:bg-white text-gray-900' : 
                        theme === 'dim' ? 'bg-dim-card focus:bg-dim-bg text-dim-text' : 
                        'bg-gray-800 focus:bg-gray-900 text-gray-100'
                    ]"
                >
                <div v-if="searchQuery" @click="searchQuery = ''" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 cursor-pointer p-1">
                    <i class="ph ph-x-circle text-xl"></i>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button @click="undo" :disabled="historyIndex <= 0" class="p-2.5 text-gray-500 hover:text-gray-900 dark:hover:text-white disabled:opacity-30 disabled:cursor-not-allowed rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="撤销 (Ctrl+Z)">
                    <i class="ph ph-arrow-u-up-left text-2xl"></i>
                </button>
            </div>
        </header>

        <!-- 书签内容滚动区 -->
        <div class="flex-1 overflow-y-auto p-4 sm:p-10 scroll-smooth" id="main-scroll">
            
            <!-- 分类列表 (可拖拽排序) -->
            <div id="categories-list" class="space-y-10 max-w-7xl mx-auto pb-24">
                
                <div v-for="category in filteredCategories" :key="category.id" :data-id="category.id" class="category-item group animate-slide-up">
                    
                    <!-- 分类标题栏 -->
                    <div class="flex items-center justify-between mb-5 select-none pl-1">
                        <div class="flex items-center gap-3">
                            <!-- 拖拽手柄 -->
                            <div class="handle cursor-grab active:cursor-grabbing p-1.5 text-gray-300 hover:text-gray-600 dark:hover:text-gray-300 transition-colors opacity-0 group-hover:opacity-100 rounded hover:bg-gray-100 dark:hover:bg-gray-800" title="拖动调整分类顺序">
                                <i class="ph ph-dots-six-vertical text-xl"></i>
                            </div>
                            
                            <button @click="toggleCollapse(category.id)" class="p-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                <i :class="['ph text-lg transition-transform duration-200', category.collapsed ? 'ph-caret-right' : 'ph-caret-down']"></i>
                            </button>
                            
                            <!-- 标题编辑 -->
                            <div class="flex items-center gap-3">
                                <div v-if="editingCategoryId === category.id" class="flex items-center gap-2">
                                    <input ref="editCatInput" v-model="tempCategoryName" @keyup.enter="saveCategoryEdit(category)" @blur="saveCategoryEdit(category)" class="bg-white dark:bg-gray-800 border border-blue-500 rounded px-2 py-1 text-lg font-bold outline-none" autoFocus>
                                    <div class="flex gap-1">
                                        <button v-for="color in categoryColors" :key="color" @click="category.color = color" :class="['w-4 h-4 rounded-full border border-gray-300 dark:border-gray-600', color, category.color === color ? 'ring-2 ring-offset-1 ring-gray-500' : '']"></button>
                                    </div>
                                </div>
                                <h2 v-else @dblclick="startEditCategory(category)" :class="['text-xl font-bold flex items-center gap-3 cursor-text', theme === 'dim' ? 'text-gray-200' : '']" title="双击编辑名称">
                                    {{ category.title }}
                                    <span :class="['w-2.5 h-2.5 rounded-full', category.color]"></span>
                                </h2>
                                <span class="text-xs font-medium bg-gray-200 dark:bg-gray-800 text-gray-500 px-2.5 py-1 rounded-md">{{ category.bookmarks.length }}</span>
                            </div>
                        </div>

                        <!-- 分类操作菜单 -->
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                             <button @click="startEditCategory(category)" class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors" title="编辑分类"><i class="ph ph-pencil-simple"></i></button>
                             <button @click="confirmDeleteCategory(category.id)" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors" title="删除分类"><i class="ph ph-trash"></i></button>
                        </div>
                    </div>

                    <!-- 书签网格 -->
                    <div v-show="!category.collapsed || searchQuery" 
                         :data-cat-id="category.id"
                         class="bookmarks-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 transition-all duration-300 min-h-[80px]">
                        
                        <!-- 书签卡片 -->
                        <!-- 关键修改：添加动态 class 处理 z-index，当菜单激活时提升层级 -->
                        <div v-for="bookmark in category.bookmarks" :key="bookmark.id" :data-id="bookmark.id" 
                            :class="[
                                'bookmark-item group/card relative border rounded-xl p-3 flex items-center gap-3 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer h-[5.5rem] select-none',
                                activeMenuId === bookmark.id ? '!z-50 ring-2 ring-blue-500/50' : 'z-0',
                                theme === 'light' ? 'bg-white border-gray-200 hover:border-blue-400' : 
                                theme === 'dim' ? 'bg-dim-card border-dim-border hover:border-blue-500 shadow-md' :
                                'bg-[#1e293b] border-gray-700 hover:border-blue-500'
                            ]"
                            @click="openBookmark(bookmark.url)"
                        >
                            <!-- 书签图标 (美化版: 更小，动态渐变背景) -->
                            <div class="w-9 h-9 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden shadow-inner ring-1 ring-black/5 dark:ring-white/5"
                                 :style="getIconStyle(bookmark.title, bookmark.url)">
                                <img :src="getFavicon(bookmark.url)" @error="handleImgError" class="w-4.5 h-4.5 object-contain mix-blend-hard-light drop-shadow-sm" alt="icon">
                            </div>
                            
                            <!-- 书签信息 -->
                            <div class="flex-1 min-w-0 pr-6">
                                <h3 :class="['font-bold text-sm truncate group-hover/card:text-blue-500', theme === 'light' ? 'text-gray-800' : 'text-gray-200']">{{ bookmark.title }}</h3>
                                <p class="text-xs text-gray-400 truncate mt-0.5 font-mono opacity-80">{{ getDomain(bookmark.url) }}</p>
                            </div>

                            <!-- 悬浮菜单按钮 -->
                            <div class="absolute top-2 right-2">
                                <button @click.stop="toggleMenu(bookmark.id)" class="p-1.5 text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 rounded-lg transition-colors opacity-0 group-hover/card:opacity-100 focus:opacity-100" 
                                    :class="{'opacity-100 bg-black/5 dark:bg-white/10': activeMenuId === bookmark.id, 'hover:bg-gray-100 dark:hover:bg-gray-700': activeMenuId !== bookmark.id}">
                                    <i class="ph ph-dots-three-vertical text-lg"></i>
                                </button>
                                
                                <!-- 下拉菜单 -->
                                <div v-if="activeMenuId === bookmark.id" 
                                    :class="[
                                        'absolute right-0 top-8 w-36 shadow-xl rounded-xl border py-1.5 flex flex-col animate-scale-in origin-top-right',
                                        theme === 'light' ? 'bg-white border-gray-200' : 
                                        theme === 'dim' ? 'bg-[#27272a] border-dim-border' :
                                        'bg-gray-800 border-gray-700'
                                    ]"
                                >
                                    <button @click.stop="startEditBookmark(category.id, bookmark, true); activeMenuId = null" class="w-full text-left px-4 py-2 text-xs font-medium text-gray-500 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-500/10 flex items-center gap-2">
                                        <i class="ph ph-folder-notch-plus text-base"></i> 移动分类
                                    </button>
                                    <button @click.stop="startEditBookmark(category.id, bookmark, false); activeMenuId = null" class="w-full text-left px-4 py-2 text-xs font-medium text-gray-500 hover:text-amber-500 hover:bg-amber-50 dark:hover:bg-amber-500/10 flex items-center gap-2">
                                        <i class="ph ph-pencil-simple text-base"></i> 编辑信息
                                    </button>
                                    <div class="h-px bg-gray-100 dark:bg-white/5 my-1"></div>
                                    <button @click.stop="deleteBookmark(category.id, bookmark.id)" class="w-full text-left px-4 py-2 text-xs font-medium text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 flex items-center gap-2">
                                        <i class="ph ph-trash text-base"></i> 删除书签
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 空状态提示 -->
                        <div v-if="category.bookmarks.length === 0" class="col-span-full py-8 flex flex-col items-center justify-center text-gray-400 border-2 border-dashed border-gray-200 dark:border-gray-800 rounded-xl bg-gray-50/50 dark:bg-gray-800/30 transition-colors hover:bg-gray-100 dark:hover:bg-gray-800/50">
                            <i class="ph ph-ghost text-3xl mb-2 opacity-50"></i>
                            <span class="text-sm">暂无书签，拖拽至此添加</span>
                        </div>
                    </div>
                </div>

                <!-- 搜索无结果 -->
                <div v-if="searchQuery && filteredCategories.length === 0" class="text-center py-24 animate-fade-in">
                    <div class="inline-flex p-5 bg-gray-100 dark:bg-gray-800 rounded-full mb-4">
                        <i class="ph ph-magnifying-glass text-4xl text-gray-400"></i>
                    </div>
                    <h3 class="text-xl font-medium mb-1">未找到相关结果</h3>
                    <p class="text-gray-500">尝试更换关键词或添加新书签</p>
                </div>
            </div>
        </div>
    </main>

    <!-- 快速添加按钮 (FAB) -->
    <button @click.stop="openAddModal" class="fixed bottom-10 right-10 w-16 h-16 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-2xl hover:shadow-blue-500/50 flex items-center justify-center transition-all hover:scale-110 active:scale-95 z-40 group">
        <i class="ph ph-plus text-3xl group-hover:rotate-90 transition-transform duration-300"></i>
    </button>

    <!-- 模态框: 添加/编辑书签 -->
    <div v-if="showModal" class="fixed inset-0 z-[70] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" @click="closeModal"></div>
        <div :class="['w-full max-w-lg rounded-2xl shadow-2xl z-10 overflow-hidden transform transition-all animate-slide-up border', theme === 'light' ? 'bg-white border-gray-200' : 'bg-gray-900 border-gray-800']">
            <!-- 头部 -->
            <div class="flex border-b border-gray-200 dark:border-gray-800">
                <button v-for="m in ['bookmark', 'category']" :key="m" @click="modalMode = m" 
                    :class="['flex-1 py-4 text-sm font-bold tracking-wide uppercase transition-colors', modalMode === m ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:bg-gray-50 dark:hover:bg-gray-800']">
                    {{ m === 'bookmark' ? (isEditing ? '编辑/移动书签' : '添加书签') : '新建分类' }}
                </button>
            </div>

            <!-- 表单 -->
            <div class="p-6 space-y-5">
                <!-- 添加书签表单 -->
                <div v-if="modalMode === 'bookmark'" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">网址 URL</label>
                        <div class="relative">
                            <input ref="urlInput" v-model="form.url" @input="autoIdentify" type="text" placeholder="https://example.com" class="w-full bg-gray-100 dark:bg-gray-800 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all font-mono text-sm dark:text-gray-200">
                            <div v-if="identifying" class="absolute right-3 top-3"><i class="ph ph-spinner animate-spin text-blue-500"></i></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">名称</label>
                            <input v-model="form.title" type="text" placeholder="网站名称" class="w-full bg-gray-100 dark:bg-gray-800 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-gray-200">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-blue-600 dark:text-blue-400 mb-1">选择分类 (移动到)</label>
                            <div class="relative">
                                <select ref="catSelect" v-model="form.categoryId" class="w-full bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all appearance-none cursor-pointer font-medium text-blue-700 dark:text-blue-300">
                                    <option v-for="cat in categories" :key="cat.id" :value="cat.id">{{ cat.title }}</option>
                                </select>
                                <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-blue-500">
                                    <i class="ph ph-caret-down-bold"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 添加分类表单 -->
                <div v-else class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">分类名称</label>
                        <input ref="catNameInput" v-model="form.categoryTitle" @keyup.enter="handleSubmit" type="text" placeholder="例如：工作、娱乐、开发" class="w-full bg-gray-100 dark:bg-gray-800 rounded-lg px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all dark:text-gray-200">
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-gray-500 mb-1">标签颜色</label>
                         <div class="flex flex-wrap gap-3 mt-2">
                             <button v-for="color in categoryColors" :key="color" @click="form.color = color" 
                                :class="['w-8 h-8 rounded-full transition-transform hover:scale-110', color, form.color === color ? 'ring-2 ring-offset-2 ring-blue-500 dark:ring-offset-gray-900 scale-110' : '']">
                             </button>
                         </div>
                    </div>
                </div>
            </div>

            <!-- 底部按钮 -->
            <div class="p-4 bg-gray-50 dark:bg-gray-800/50 flex justify-end gap-3 border-t border-gray-200 dark:border-gray-800">
                <button @click="closeModal" class="px-5 py-2.5 rounded-xl text-gray-600 hover:bg-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 transition-colors font-medium">取消</button>
                <button @click="handleSubmit" class="px-6 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-500/30 transition-all font-medium flex items-center gap-2">
                    <i class="ph ph-check-bold"></i> {{ isEditing ? '保存修改' : '立即添加' }}
                </button>
            </div>
        </div>
    </div>

    <!-- 提示框 (Toast) -->
    <div class="fixed top-6 left-1/2 -translate-x-1/2 z-[80] flex flex-col gap-2 pointer-events-none">
        <div v-for="toast in toasts" :key="toast.id" :class="['px-6 py-3 rounded-full shadow-xl text-white font-medium flex items-center gap-2 animate-fade-in pointer-events-auto', toast.type === 'error' ? 'bg-red-500' : 'bg-gray-800 dark:bg-white dark:text-gray-900']">
            <i :class="['ph text-lg', toast.type === 'success' ? 'ph-check-circle' : 'ph-warning-circle']"></i>
            {{ toast.message }}
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    createApp({
        setup() {
            // --- 状态管理 ---
            const categories = ref([]);
            const theme = ref('dark'); // 'light', 'dark', 'dim'
            const searchQuery = ref('');
            const sidebarOpen = ref(false);
            const history = ref([]);
            const historyIndex = ref(-1);
            
            // 菜单状态
            const activeMenuId = ref(null);
            
            // 模态框状态
            const showModal = ref(false);
            const modalMode = ref('bookmark'); // 'bookmark' or 'category'
            const isEditing = ref(false);
            const identifying = ref(false);
            const editingBookId = ref(null);
            
            // 编辑分类状态
            const editingCategoryId = ref(null);
            const tempCategoryName = ref('');

            // 表单数据
            const form = ref({
                url: '',
                title: '',
                categoryId: '',
                categoryTitle: '',
                color: 'bg-blue-500'
            });

            // 提示消息
            const toasts = ref([]);

            // 常量
            const categoryColors = [
                'bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500', 
                'bg-green-500', 'bg-emerald-500', 'bg-teal-500', 'bg-cyan-500', 
                'bg-blue-500', 'bg-indigo-500', 'bg-violet-500', 'bg-purple-500', 'bg-pink-500'
            ];
            
            // 自动分类关键词
            const categoryKeywords = {
                '社交媒体': ['facebook', 'twitter', 'instagram', 'linkedin', 'weibo', 'zhihu', 'reddit', 'douyin', 'tiktok', 'wechat'],
                '视频娱乐': ['youtube', 'bilibili', 'netflix', 'youku', 'iqiyi', 'twitch', 'video'],
                '开发工具': ['github', 'gitlab', 'stackoverflow', 'csdn', 'w3school', 'mdn', 'chatgpt', 'openai', 'claude', 'deepseek'],
                '设计资源': ['figma', 'dribbble', 'behance', 'unsplash', 'iconfont', 'canva'],
                '购物消费': ['amazon', 'taobao', 'jd', 'tmall', 'ebay', 'pinduoduo'],
                '新闻资讯': ['news', 'bbc', 'cnn', 'sina', '163', 'qq'],
                '办公协作': ['notion', 'slack', 'feishu', 'dingtalk', 'zoom', 'docs', 'pan', 'baidu']
            };

            // --- 生命周期 & 初始化 ---
            onMounted(() => {
                loadData();
                initTheme();
                initSortable();
                
                // 键盘快捷键
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                        e.preventDefault();
                        undo();
                    }
                    if (e.key === 'Escape') {
                        closeModal();
                        activeMenuId.value = null;
                    }
                });
            });

            // 监听数据变化，记录历史 (Debounced)
            let historyTimeout;
            watch(categories, (newVal) => {
                clearTimeout(historyTimeout);
                historyTimeout = setTimeout(() => {
                    saveData();
                    pushHistory();
                }, 500);
            }, { deep: true });

            watch(theme, (newVal) => {
                // Tailwind class logic
                const html = document.documentElement;
                if (newVal === 'dark' || newVal === 'dim') {
                    html.classList.add('dark');
                } else {
                    html.classList.remove('dark');
                }
                localStorage.setItem('navmark-theme', newVal);
            });

            // --- 核心逻辑 ---

            // 计算总书签数
            const totalBookmarks = computed(() => {
                return categories.value.reduce((acc, cat) => acc + cat.bookmarks.length, 0);
            });

            // 搜索过滤
            const filteredCategories = computed(() => {
                if (!searchQuery.value) return categories.value;
                const query = searchQuery.value.toLowerCase();
                return categories.value.map(cat => {
                    // 如果分类名匹配，显示所有；或者只显示匹配的书签
                    const matchCat = cat.title.toLowerCase().includes(query);
                    const filteredBookmarks = cat.bookmarks.filter(b => 
                        b.title.toLowerCase().includes(query) || b.url.toLowerCase().includes(query)
                    );
                    
                    if (matchCat || filteredBookmarks.length > 0) {
                        return { ...cat, bookmarks: matchCat ? cat.bookmarks : filteredBookmarks };
                    }
                    return null;
                }).filter(Boolean);
            });

            // 菜单逻辑
            const toggleMenu = (id) => {
                activeMenuId.value = activeMenuId.value === id ? null : id;
            };

            const closeAllMenus = () => {
                activeMenuId.value = null;
            };

            // 图标美化 (使用渐变)
            const getIconStyle = (title, url) => {
                // 生成一个基于字符串的随机颜色
                let hash = 0;
                const str = (title + url).toLowerCase();
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                
                // 基础色相
                const h = Math.abs(hash) % 360; 
                // 辅助色相 (偏转 45 度)
                const h2 = (h + 45) % 360;

                // 饱和度和亮度调整
                const s = 65 + (Math.abs(hash) % 20); // 65-85%
                const l = 80 + (Math.abs(hash) % 10); // 80-90% (Light)
                
                // 深色模式调整
                const isDark = theme.value !== 'light';
                const finalL = isDark ? 25 : l; 
                const finalS = isDark ? 50 : s;

                // 构建线性渐变
                const color1 = `hsl(${h}, ${finalS}%, ${finalL}%)`;
                const color2 = `hsl(${h2}, ${finalS}%, ${finalL - 5}%)`;

                return {
                    background: `linear-gradient(135deg, ${color1}, ${color2})`
                };
            };

            // 添加书签
            const openAddModal = () => {
                resetForm();
                modalMode.value = 'bookmark';
                isEditing.value = false;
                showModal.value = true;
                if (categories.value.length > 0) form.value.categoryId = categories.value[0].id;
                nextTick(() => document.querySelector('input')?.focus());
            };

            const resetForm = () => {
                form.value = { url: '', title: '', categoryId: '', categoryTitle: '', color: 'bg-blue-500' };
            };

            const closeModal = () => {
                showModal.value = false;
                editingCategoryId.value = null;
            };

            // 智能识别
            const autoIdentify = () => {
                const url = form.value.url;
                if (!url || isEditing.value) return;

                const lowerUrl = url.toLowerCase();
                for (const [name, keywords] of Object.entries(categoryKeywords)) {
                    if (keywords.some(k => lowerUrl.includes(k))) {
                        const existCat = categories.value.find(c => c.title === name);
                        if (existCat) form.value.categoryId = existCat.id;
                        break;
                    }
                }
                
                try {
                    const hostname = new URL(url.startsWith('http') ? url : 'https://' + url).hostname;
                    if (!form.value.title) {
                        const parts = hostname.split('.');
                        form.value.title = parts.length > 2 ? capitalize(parts[parts.length - 2]) : capitalize(parts[0]);
                    }
                } catch(e) {}
            };

            const handleSubmit = () => {
                if (modalMode.value === 'bookmark') {
                    if (!form.value.url) return showToast('请输入网址', 'error');
                    
                    let finalUrl = form.value.url;
                    if (!/^https?:\/\//i.test(finalUrl)) finalUrl = 'https://' + finalUrl;

                    if (isEditing.value && editingBookId.value) {
                        // 更新书签
                        categories.value.forEach(c => {
                            const idx = c.bookmarks.findIndex(b => b.id === editingBookId.value);
                            if (idx !== -1) {
                                // 如果换分类了
                                if (c.id !== form.value.categoryId) {
                                    const bm = c.bookmarks[idx];
                                    c.bookmarks.splice(idx, 1);
                                    const targetCat = categories.value.find(tc => tc.id === form.value.categoryId);
                                    if(targetCat) targetCat.bookmarks.push({ ...bm, title: form.value.title, url: finalUrl });
                                    showToast('书签已移动并更新');
                                } else {
                                    c.bookmarks[idx].title = form.value.title;
                                    c.bookmarks[idx].url = finalUrl;
                                    showToast('书签已更新');
                                }
                            }
                        });
                    } else {
                        // 新增书签
                        const newBookmark = {
                            id: crypto.randomUUID(),
                            title: form.value.title || new URL(finalUrl).hostname,
                            url: finalUrl,
                            createdAt: Date.now()
                        };
                        const cat = categories.value.find(c => c.id === form.value.categoryId);
                        if (cat) {
                            cat.bookmarks.push(newBookmark);
                            showToast('书签添加成功');
                        } else {
                            // 如果没有分类，创建一个"未分类"
                            const newCat = {
                                id: crypto.randomUUID(),
                                title: '默认分类',
                                color: 'bg-gray-500',
                                collapsed: false,
                                bookmarks: [newBookmark]
                            };
                            categories.value.push(newCat);
                            initSortable(); // 重新绑定
                        }
                    }
                } else {
                    // 新增分类
                    if (!form.value.categoryTitle) return showToast('请输入分类名称', 'error');
                    categories.value.push({
                        id: crypto.randomUUID(),
                        title: form.value.categoryTitle,
                        color: form.value.color,
                        collapsed: false,
                        bookmarks: []
                    });
                    showToast('分类创建成功');
                    initSortable();
                }
                closeModal();
            };

            // 编辑功能 (enhanced with focusCat option)
            const startEditBookmark = (catId, bookmark, focusCat = false) => {
                modalMode.value = 'bookmark';
                isEditing.value = true;
                editingBookId.value = bookmark.id;
                form.value.url = bookmark.url;
                form.value.title = bookmark.title;
                form.value.categoryId = catId;
                showModal.value = true;
                activeMenuId.value = null; // Close menu
                
                // 如果是点击了“移动分类”按钮，聚焦到分类选择框
                if (focusCat) {
                    nextTick(() => {
                        const select = document.querySelector('select');
                        if (select) {
                            select.focus();
                            select.click(); // 尝试展开 (部分浏览器可能不支持)
                        }
                    });
                }
            };

            const deleteBookmark = (catId, bookId) => {
                activeMenuId.value = null; // Close menu
                if(!confirm('确定删除此书签吗？')) return;
                const cat = categories.value.find(c => c.id === catId);
                if(cat) {
                    cat.bookmarks = cat.bookmarks.filter(b => b.id !== bookId);
                    pushHistory();
                }
            };

            const startEditCategory = (cat) => {
                editingCategoryId.value = cat.id;
                tempCategoryName.value = cat.title;
                nextTick(() => {
                    const inputs = document.querySelectorAll('input');
                    // 简单的查找逻辑
                });
            };

            const saveCategoryEdit = (cat) => {
                if(editingCategoryId.value === cat.id) {
                    if(tempCategoryName.value.trim()) {
                        cat.title = tempCategoryName.value;
                    }
                    editingCategoryId.value = null;
                }
            };

            const confirmDeleteCategory = (id) => {
                if(confirm('确定删除此分类及其所有书签吗？此操作可撤销。')) {
                    categories.value = categories.value.filter(c => c.id !== id);
                    showToast('分类已删除');
                }
            };

            // --- 工具函数 ---

            const initTheme = () => {
                const saved = localStorage.getItem('navmark-theme');
                // Default to dark, or mixed if previously saved, or system preference
                if (saved) {
                    theme.value = saved;
                } else {
                    theme.value = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                }
                
                // Apply classes
                const html = document.documentElement;
                if (theme.value === 'dark' || theme.value === 'dim') html.classList.add('dark');
                else html.classList.remove('dark');
            };

            const toggleTheme = (val) => theme.value = val;

            const toggleCollapse = (id) => {
                const cat = categories.value.find(c => c.id === id);
                if(cat) cat.collapsed = !cat.collapsed;
            };

            const toggleAllCategories = (collapsed) => {
                categories.value.forEach(c => c.collapsed = collapsed);
            };

            const getFavicon = (url) => {
                try {
                    const domain = new URL(url).hostname;
                    return `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
                } catch { return ''; }
            };
            
            const handleImgError = (e) => {
                // 如果 favicon 加载失败，显示透明（背景色已经有了）
                e.target.style.opacity = '0.3'; 
            };

            const getDomain = (url) => {
                try { return new URL(url).hostname.replace('www.', ''); } catch { return url; }
            };

            const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);

            const showToast = (msg, type = 'success') => {
                const id = Date.now();
                toasts.value.push({ id, message: msg, type });
                setTimeout(() => {
                    toasts.value = toasts.value.filter(t => t.id !== id);
                }, 3000);
            };

            // --- 数据持久化 & 撤销 ---
            
            const loadData = () => {
                const saved = localStorage.getItem('navmark-data');
                if (saved) {
                    categories.value = JSON.parse(saved);
                } else {
                    // 初始化默认数据 (仅保留一个常用推荐分类，包含邮箱和网盘)
                    categories.value = [
                        {
                            id: 'default-1', title: '常用推荐', color: 'bg-blue-500', collapsed: false,
                            bookmarks: [
                                 // 常用邮箱
                                 { id: 'bm-em-1', title: 'Gmail', url: 'https://mail.google.com', createdAt: Date.now() },
                                 { id: 'bm-em-2', title: 'Outlook', url: 'https://outlook.live.com', createdAt: Date.now() },
                                 { id: 'bm-em-3', title: 'QQ邮箱', url: 'https://mail.qq.com', createdAt: Date.now() },
                                 { id: 'bm-em-4', title: '163网易邮箱', url: 'https://mail.163.com', createdAt: Date.now() },
                                 // 常用网盘
                                 { id: 'bm-cl-1', title: '百度网盘', url: 'https://pan.baidu.com', createdAt: Date.now() },
                                 { id: 'bm-cl-2', title: '阿里云盘', url: 'https://www.aliyundrive.com', createdAt: Date.now() },
                                 { id: 'bm-cl-3', title: 'Google Drive', url: 'https://drive.google.com', createdAt: Date.now() },
                                 // 其他推荐
                                 { id: 'bm-ex-1', title: '哔哩哔哩', url: 'https://www.bilibili.com', createdAt: Date.now() },
                                 { id: 'bm-ex-2', title: 'GitHub', url: 'https://github.com', createdAt: Date.now() },
                                 { id: 'bm-ex-3', title: 'ChatGPT', url: 'https://chat.openai.com', createdAt: Date.now() },
                            ]
                        }
                    ];
                }
                pushHistory(); // 初始状态
            };

            const saveData = () => {
                localStorage.setItem('navmark-data', JSON.stringify(categories.value));
            };

            const pushHistory = () => {
                // 深拷贝当前状态
                const state = JSON.stringify(categories.value);
                // 避免重复推入相同状态
                if (history.value[historyIndex.value] === state) return;
                
                // 删除当前指针之后的历史（如果发生了分叉）
                const newHistory = history.value.slice(0, historyIndex.value + 1);
                newHistory.push(state);
                
                // 限制历史长度
                if(newHistory.length > 20) newHistory.shift();
                
                history.value = newHistory;
                historyIndex.value = newHistory.length - 1;
            };

            const undo = () => {
                if (historyIndex.value > 0) {
                    historyIndex.value--;
                    categories.value = JSON.parse(history.value[historyIndex.value]);
                    saveData();
                    showToast('已撤销上一步操作');
                }
            };

            const resetData = () => {
                if (confirm('警告：此操作将清空所有数据并恢复默认设置，且不可撤销！')) {
                    localStorage.removeItem('navmark-data');
                    location.reload();
                }
            };

            // --- 导入导出 ---
            
            const exportBookmarks = (format) => {
                if (format === 'json') {
                    downloadFile(JSON.stringify(categories.value, null, 2), 'navmark-backup.json', 'application/json');
                } else {
                    let html = `<!DOCTYPE NETSCAPE-Bookmark-file-1>\n<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">\n<TITLE>NavMark Bookmarks</TITLE>\n<H1>Bookmarks</H1>\n<DL><p>\n`;
                    categories.value.forEach(cat => {
                        html += `    <DT><H3>${cat.title}</H3>\n    <DL><p>\n`;
                        cat.bookmarks.forEach(b => {
                            html += `        <DT><A HREF="${b.url}" ADD_DATE="${Math.floor(b.createdAt/1000)}">${b.title}</A>\n`;
                        });
                        html += `    </DL><p>\n`;
                    });
                    html += `</DL><p>`;
                    downloadFile(html, 'bookmarks.html', 'text/html');
                }
            };

            const downloadFile = (content, filename, type) => {
                const blob = new Blob([content], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            };

            const importBookmarks = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const html = ev.target.result;
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const newCategories = [];
                    // 查找文件夹
                    doc.querySelectorAll('h3').forEach(h3 => {
                        const title = h3.textContent;
                        const dl = h3.nextElementSibling;
                        if(dl && dl.tagName === 'DL') {
                            const bookmarks = [];
                            dl.querySelectorAll('a').forEach(a => {
                                bookmarks.push({
                                    id: crypto.randomUUID(),
                                    title: a.textContent,
                                    url: a.href,
                                    createdAt: Date.now()
                                });
                            });
                            if(bookmarks.length > 0) {
                                newCategories.push({
                                    id: crypto.randomUUID(),
                                    title,
                                    color: categoryColors[Math.floor(Math.random()*categoryColors.length)],
                                    collapsed: false,
                                    bookmarks
                                });
                            }
                        }
                    });
                    
                    if(newCategories.length > 0) {
                        // 简单的合并策略：追加
                        categories.value = [...categories.value, ...newCategories];
                        showToast(`成功导入 ${newCategories.length} 个分类`);
                        saveData();
                    } else {
                        showToast('未找到有效的书签数据', 'error');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const deduplicateBookmarks = () => {
                const seen = new Set();
                let count = 0;
                categories.value.forEach(cat => {
                    cat.bookmarks = cat.bookmarks.filter(b => {
                        const key = b.url.trim().toLowerCase();
                        if(seen.has(key)) {
                            count++;
                            return false;
                        }
                        seen.add(key);
                        return true;
                    });
                });
                if(count > 0) showToast(`已清理 ${count} 个重复书签`);
                else showToast('暂无重复书签');
            };

            // --- 拖拽排序 SortableJS ---
            
            let sortableInstances = [];

            const initSortable = () => {
                // 清理旧实例，防止内存泄漏或重复绑定
                sortableInstances.forEach(s => s.destroy());
                sortableInstances = [];

                if (searchQuery.value) return; // 搜索时禁用拖拽

                nextTick(() => {
                    // 1. 分类排序 (Categories)
                    const catContainer = document.getElementById('categories-list'); // 必须对应 HTML 中的 ID
                    if (catContainer) {
                        const s = Sortable.create(catContainer, {
                            animation: 200,
                            handle: '.handle', // 必须点那个六点图标才能拖
                            ghostClass: 'sortable-ghost',
                            onEnd: (evt) => {
                                if (evt.oldIndex === evt.newIndex) return;
                                // 移动数据
                                const item = categories.value.splice(evt.oldIndex, 1)[0];
                                categories.value.splice(evt.newIndex, 0, item);
                                // 保存历史
                                pushHistory();
                            }
                        });
                        sortableInstances.push(s);
                    }

                    // 2. 书签排序 (Bookmarks) - 支持跨分类拖动
                    const containers = document.querySelectorAll('.bookmarks-grid');
                    containers.forEach(el => {
                        const s = Sortable.create(el, {
                            group: 'shared-bookmarks', // 允许在不同列表间拖动
                            animation: 200,
                            delay: 50, // 稍微延迟防止误触点击
                            delayOnTouchOnly: true,
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            onEnd: (evt) => {
                                if (searchQuery.value) return;
                                
                                const { from, to, oldIndex, newIndex } = evt;
                                
                                // 获取分类ID (从 data-cat-id 属性)
                                const fromCatId = from.getAttribute('data-cat-id');
                                const toCatId = to.getAttribute('data-cat-id');
                                
                                // 如果没变位置，直接返回
                                if (from === to && oldIndex === newIndex) return;

                                // 找到源分类和目标分类的数据对象
                                const sourceCat = categories.value.find(c => c.id === fromCatId);
                                const targetCat = categories.value.find(c => c.id === toCatId);

                                if (sourceCat && targetCat) {
                                    // 移动数据逻辑：
                                    // 1. 从源数组移除
                                    const [movedItem] = sourceCat.bookmarks.splice(oldIndex, 1);
                                    // 2. 插入到目标数组
                                    targetCat.bookmarks.splice(newIndex, 0, movedItem);
                                    
                                    pushHistory();
                                }
                            }
                        });
                        sortableInstances.push(s);
                    });
                });
            };

            // 监听分类变化重新绑定 Sortable（例如新增分类、导入数据后）
            watch(() => categories.value.length, () => initSortable());
            // 监听搜索，搜索时禁用，取消搜索时启用
            watch(searchQuery, () => initSortable());

            const openBookmark = (url) => {
                window.open(url, '_blank');
            };

            return {
                categories, theme, searchQuery, sidebarOpen, showModal, modalMode, form, isEditing, identifying, toasts,
                filteredCategories, categoryColors, editingCategoryId, tempCategoryName, historyIndex, totalBookmarks, activeMenuId,
                openAddModal, closeModal, autoIdentify, handleSubmit, toggleCollapse, toggleTheme,
                toggleAllCategories, exportBookmarks, importBookmarks, resetData, undo, deduplicateBookmarks,
                startEditBookmark, deleteBookmark, openBookmark, startEditCategory, saveCategoryEdit, confirmDeleteCategory,
                getFavicon, getDomain, handleImgError, getIconStyle, toggleMenu, closeAllMenus
            };
        }
    }).mount('#app');
</script>
</body>
</html>
